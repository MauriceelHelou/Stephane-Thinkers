name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      test_category:
        description: 'Test category to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - journey
          - visual
          - smoke

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright

jobs:
  lint:
    name: Lint & Type Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: TypeScript type check
        working-directory: frontend
        run: npm run type-check

      - name: Lint tests
        working-directory: frontend
        run: npx eslint tests/ --ext .ts --max-warnings 0

  test-backend:
    name: Backend Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run backend tests
        working-directory: backend
        run: |
          pytest tests/ -v --cov=app --cov-report=xml --cov-report=html

      - name: Upload backend coverage
        uses: codecov/codecov-action@v4
        with:
          files: backend/coverage.xml
          flags: backend
          name: backend-coverage

  e2e-tests:
    name: E2E Tests (${{ matrix.shard }}/${{ matrix.total-shards }})
    runs-on: ubuntu-latest
    needs: [lint, test-backend]
    strategy:
      fail-fast: false
      matrix:
        shard: [1, 2, 3, 4]
        total-shards: [4]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Install Playwright system dependencies
        if: steps.playwright-cache.outputs.cache-hit == 'true'
        run: npx playwright install-deps chromium
        working-directory: frontend

      - name: Install backend dependencies
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start backend server
        working-directory: backend
        run: |
          uvicorn app.main:app --host 0.0.0.0 --port 8001 &
          sleep 5
        env:
          DATABASE_URL: sqlite:///./test_db.db
          FRONTEND_URL: http://localhost:3001

      - name: Build and start frontend
        working-directory: frontend
        run: |
          npm run build
          npm start &
          sleep 10
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8001

      - name: Wait for services
        run: |
          npx wait-on http://localhost:3001 http://localhost:8001/api/health --timeout 60000

      - name: Run E2E tests (shard ${{ matrix.shard }})
        working-directory: frontend
        run: |
          npx playwright test \
            --config=tests/playwright.ci.config.ts \
            --shard=${{ matrix.shard }}/${{ matrix.total-shards }} \
            --reporter=blob
        env:
          CI: true
          PLAYWRIGHT_TEST_BASE_URL: http://localhost:3001
          API_BASE_URL: http://localhost:8001

      - name: Upload blob report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: blob-report-${{ matrix.shard }}
          path: frontend/blob-report
          retention-days: 7

      - name: Upload test screenshots
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-screenshots-${{ matrix.shard }}
          path: frontend/test-results
          retention-days: 7

  visual-regression:
    name: Visual Regression Tests
    runs-on: ubuntu-latest
    needs: [lint, test-backend]
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          cache-dependency-path: backend/requirements.txt

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        id: playwright-cache
        with:
          path: ${{ env.PLAYWRIGHT_BROWSERS_PATH }}
          key: playwright-browsers-${{ runner.os }}-${{ hashFiles('frontend/package-lock.json') }}

      - name: Install dependencies
        run: |
          cd frontend && npm ci
          cd ../backend && pip install -r requirements.txt

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        working-directory: frontend
        run: npx playwright install --with-deps chromium

      - name: Start services
        run: |
          cd backend && uvicorn app.main:app --host 0.0.0.0 --port 8001 &
          cd frontend && npm run build && npm start &
          sleep 15
        env:
          DATABASE_URL: sqlite:///./test_db.db
          FRONTEND_URL: http://localhost:3001
          NEXT_PUBLIC_API_URL: http://localhost:8001

      - name: Run visual tests
        working-directory: frontend
        run: |
          npx playwright test tests/visual/ \
            --config=tests/playwright.ci.config.ts \
            --update-snapshots
        env:
          CI: true

      - name: Upload visual diff artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diff
          path: |
            frontend/test-results
            frontend/tests/visual/**/*.png
          retention-days: 14

  merge-reports:
    name: Merge Test Reports
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    if: always()
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Download blob reports
        uses: actions/download-artifact@v4
        with:
          path: frontend/all-blob-reports
          pattern: blob-report-*
          merge-multiple: true

      - name: Merge reports
        working-directory: frontend
        run: |
          npx playwright merge-reports \
            --reporter html,json \
            ./all-blob-reports

      - name: Upload HTML report
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report
          retention-days: 30

      - name: Upload JSON report
        uses: actions/upload-artifact@v4
        with:
          name: test-results-json
          path: frontend/test-results.json
          retention-days: 30

      - name: Publish to GitHub Pages
        if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: frontend/playwright-report
          destination_dir: test-reports/${{ github.run_number }}

  notify:
    name: Notify Results
    runs-on: ubuntu-latest
    needs: [merge-reports, visual-regression]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          name: test-results-json
          path: .

      - name: Generate summary
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            let results = { passed: 0, failed: 0, skipped: 0, total: 0 };
            try {
              const data = JSON.parse(fs.readFileSync('test-results.json', 'utf8'));
              results = {
                passed: data.stats?.expected || 0,
                failed: data.stats?.unexpected || 0,
                skipped: data.stats?.skipped || 0,
                total: data.stats?.expected + data.stats?.unexpected + data.stats?.skipped || 0
              };
            } catch (e) {
              console.log('Could not read test results:', e.message);
            }

            const status = results.failed > 0 ? ':x:' : ':white_check_mark:';
            const summary = `
            ## E2E Test Results ${status}

            | Metric | Count |
            |--------|-------|
            | :white_check_mark: Passed | ${results.passed} |
            | :x: Failed | ${results.failed} |
            | :fast_forward: Skipped | ${results.skipped} |
            | **Total** | **${results.total}** |

            [View Full Report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

  cleanup:
    name: Cleanup Artifacts
    runs-on: ubuntu-latest
    needs: [notify]
    if: always()
    steps:
      - name: Delete blob reports
        uses: geekyeggo/delete-artifact@v5
        with:
          name: blob-report-*
          failOnError: false
